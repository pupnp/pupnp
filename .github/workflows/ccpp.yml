name: C/C++ CI

on: [push, pull_request]

jobs:
  build:
    name: Build (${{ matrix.os }})
    runs-on: ${{ matrix.os }}

    strategy:
      matrix:
        os: [macos-latest, ubuntu-20.04]
    
    steps:
    - uses: actions/checkout@v1
    - name: Install build tools
      if: matrix.os == 'macos-latest'
      run: brew install autoconf automake libtool pkg-config
    - name: bootstrap and configure
      run: ./bootstrap && ./configure --enable-debug
    - name: make
      run: make
    - name: make distcheck
      run: make distcheck || (pwd && ls -la && find . -name 'test*' && find . -name *.txt && cd libupnp-1.4.8/_build/sub && cat upnp/test-suite.log upnp/test_init.log upnp/IUpnpInfoFile.txt && exit 1)

  build_asan:
    name: Sanitizer build (ubuntu-20.04)
    runs-on: ubuntu-20.04

    steps:
    - uses: actions/checkout@v1
    - name: bootstrap and configure
      run: |
        ./bootstrap
        ./configure --enable-debug \
          CFLAGS="-fsanitize=address,leak" \
          LDFLAGS="-fsanitize=address,leak"
    - name: make
      run: make
    - name: make check (upnp)
      run: cd upnp && make check && cat test_init.log || (cat test-suite.log && exit 1)
    - name: make check (ixml)
      run: cd ixml && make check || (cat test-suite.log && exit 1)
